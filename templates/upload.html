{% extends "base.html" %}

{% block title %}Upload Document - Multi-Plant Document Management System{% endblock %}

{% block extra_css %}
<style>
    .drop-zone {
        border: 2px dashed #adb5bd;
        border-radius: .5rem;
        padding: 4rem;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }
    .drop-zone.dragover {
        background-color: #e9ecef;
        border-color: #495057;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-upload me-2"></i>Upload New Document</h4>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Document Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Plants</label>
                            <div class="form-check-group">{% for plant in plants %}<div class="form-check"><input class="form-check-input" type="checkbox" name="plant_ids" value="{{ plant.id }}" id="plant_{{ plant.id }}"><label class="form-check-label" for="plant_{{ plant.id }}">{{ plant.name }}</label></div>{% endfor %}</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Departments</label>
                            <div class="form-check-group">{% for department in departments %}<div class="form-check"><input class="form-check-input" type="checkbox" name="department_ids" value="{{ department.id }}" id="department_{{ department.id }}"><label class="form-check-label" for="department_{{ department.id }}">{{ department.name }}</label></div>{% endfor %}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="document_type_id" class="form-label">Document Type</label>
                        <select class="form-select" id="document_type_id" name="document_type_id" required>
                            <option value="">Select Document Type</option>
                            {% for doc_type in document_types %}<option value="{{ doc_type.id }}">{{ doc_type.name }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="file" class="form-label">Document File</label>
                        <div class="drop-zone" id="dropZone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                            <p class="mt-3 mb-0" id="dropZoneText">Drag & drop a file here or click to select</p>
                            <input class="form-control" type="file" id="file" name="file" required style="display:none;">
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn"><i class="fas fa-cloud-upload-alt me-2"></i>Upload</button>
                    </div>
                </form>
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('file');
    const dropZoneText = document.getElementById('dropZoneText');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        if (fileInput.files.length) dropZoneText.textContent = `Selected: ${fileInput.files[0].name}`;
    });
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) dropZoneText.textContent = `Selected: ${fileInput.files[0].name}`;
    });

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        DMS.setLoadingState(uploadBtn, true, 'Uploading...');
        uploadStatus.innerHTML = '';

        try {
            const formData = new FormData(this);
            const response = await fetch("{{ url_for('main.upload_document') }}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
            });
            const data = await response.json();
            if (response.ok) {
                DMS.showNotification(data.message, 'success');
                this.reset();
                dropZoneText.textContent = 'Drag & drop a file here or click to select';
            } else {
                DMS.showNotification(data.error || 'Upload failed', 'danger');
            }
        } catch (error) {
            DMS.showNotification('Network error. Please try again.', 'danger');
        } finally {
            DMS.setLoadingState(uploadBtn, false, '<i class="fas fa-cloud-upload-alt me-2"></i>Upload');
        }
    });
</script>
{% endblock %}
