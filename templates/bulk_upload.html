{% extends "base.html" %}

{% block title %}Bulk Upload - Multi-Plant Document Management System{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <div class="card shadow-sm">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-layer-group me-2"></i>Bulk Upload Documents</h3>
      </div>
      <div class="card-body">
        <form id="bulkForm" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Plants</label>
              <div class="form-check-group">
                {% for plant in plants %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="plant_ids" value="{{ plant.id }}" id="bulk_plant_{{ plant.id }}">
                  <label class="form-check-label" for="bulk_plant_{{ plant.id }}">
                    {{ plant.name }}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Departments</label>
              <div class="form-check-group">
                {% for department in departments %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="department_ids" value="{{ department.id }}" id="bulk_department_{{ department.id }}">
                  <label class="form-check-label" for="bulk_department_{{ department.id }}">
                    {{ department.name }}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Document Type</label>
              <select name="document_type_id" class="form-select" required>
                <option value="">Select</option>
                {% for t in document_types %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Title Prefix (optional)</label>
            <input type="text" class="form-control" name="title_prefix" placeholder="Prefix added to each file title">
          </div>
          <div class="mb-3">
            <label class="form-label">Description (optional)</label>
            <textarea class="form-control" name="description" rows="2"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Metadata CSV (optional)</label>
            <input type="file" name="metadata_file" id="metadata_file" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" id="bulk_files" class="form-control" multiple required>
          </div>
          <div class="progress mb-3" style="height: 25px; display: none;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div class="d-grid">
            <button type="submit" id="bulkBtn" class="btn btn-primary"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Files</button>
          </div>
        </form>
        <div id="bulkStatus" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('bulkForm').addEventListener('submit', function(e){
  e.preventDefault();
  const btn = document.getElementById('bulkBtn');
  const status = document.getElementById('bulkStatus');
  const progressBar = document.getElementById('progressBar');
  const progressContainer = document.querySelector('.progress');

  DMS.setLoadingState(btn, true);
  status.innerHTML='';
  progressContainer.style.display = 'block';

  const formData = new FormData(this);
  const xhr = new XMLHttpRequest();

  xhr.open('POST', '{{ url_for("main.bulk_upload") }}', true);
  xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token() }}');

  xhr.upload.onprogress = function(event) {
    if (event.lengthComputable) {
      const percentComplete = (event.loaded / event.total) * 100;
      progressBar.style.width = percentComplete + '%';
      progressBar.innerText = Math.round(percentComplete) + '%';
    }
  };

  xhr.onload = function() {
    DMS.setLoadingState(btn, false);
    progressContainer.style.display = 'none';
    if (xhr.status === 200) {
      const data = JSON.parse(xhr.responseText);
      status.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
      document.getElementById('bulkForm').reset();
    } else {
      const data = JSON.parse(xhr.responseText);
      status.innerHTML = `<div class="alert alert-danger">${data.error || 'Bulk upload failed'}</div>`;
    }
  };

  xhr.onerror = function() {
    DMS.setLoadingState(btn, false);
    progressContainer.style.display = 'none';
    status.innerHTML = `<div class="alert alert-danger">Network error</div>`;
  };

  xhr.send(formData);
});
</script>
{% endblock %}


