{% extends "base.html" %}

{% block title %}User Management - Multi-Plant Document Management System{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users-cog me-2"></i>User Management</h2>
    <div class="d-flex">
      <input type="text" id="userSearch" class="form-control me-2" placeholder="Search users...">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal"><i class="fas fa-user-plus me-2"></i>Create User</button>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Username</th>

            <th>Plant</th>
            <th>Department</th>
            <th>Role</th>
            <th>Active</th>
            <th>Created</th>
            <th>Last Login</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>

            <td>
              {% for plant in u.plant_name.split(',') %}
                <span class="badge bg-primary">{{ plant.strip() }}</span>
              {% endfor %}
            </td>
            <td>
              {% for dept in u.department_name.split(',') %}
                <span class="badge bg-info">{{ dept.strip() }}</span>
              {% endfor %}
            </td>
            <td><span class="badge bg-secondary">{{ u.role }}</span></td>
            <td>
              {% if u.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-danger">Inactive</span>
              {% endif %}
            </td>
            <td><small class="text-muted">{{ u.created_at.strftime('%Y-%m-%d %H:%M') if u.created_at else '-' }}</small></td>
            <td><small class="text-muted">{{ u.last_login.strftime('%Y-%m-%d %H:%M') if u.last_login else 'Never' }}</small></td>
            <td>
              <div class="btn-group" role="group" aria-label="User Actions">
                <button class="btn btn-sm btn-outline-primary" onclick="openEdit({{ u.id }}, '{{ u.username }}', '{{ u.role }}', '{{ u.plant_name }}', '{{ u.department_name }}')" title="Edit User"><i class="fas fa-pen"></i></button>
                <button class="btn btn-sm btn-outline-warning" onclick="openReset({{ u.id }}, '{{ u.username }}')" title="Reset Password"><i class="fas fa-key"></i></button>
                {% if u.is_active %}
                  <button class="btn btn-sm btn-outline-danger" onclick="deactivateUser({{ u.id }}, '{{ u.username }}')" title="Deactivate User"><i class="fas fa-times-circle"></i></button>
                {% else %}
                  <button class="btn btn-sm btn-outline-success" onclick="activateUser({{ u.id }}, '{{ u.username }}')" title="Activate User"><i class="fas fa-check-circle"></i></button>
                {% endif %}
                <button class="btn btn-sm btn-outline-secondary" disabled title="User deletion is disabled"><i class="fas fa-trash"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
          {% if not users %}
          <tr><td colspan="10" class="text-center py-5 text-muted">No users</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  <div class="card-footer text-end">
    <a href="{{ url_for('main.audit_logs') }}" class="btn btn-outline-secondary"><i class="fas fa-clipboard-list me-2"></i>Audit Logs</a>
  </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="createUserForm">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" name="username" required>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Plant</label>
              <select name="plant_ids" id="create_plant_ids" class="form-select" multiple>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Department</label>
              <select name="department_ids" id="create_department_ids" class="form-select" multiple>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" name="password" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" class="form-select">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </form>
        <div id="createUserStatus"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="createUserBtn">Create</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <input type="hidden" id="edit_user_id" name="user_id">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" id="edit_username" name="username" required>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Plant</label>
              <select name="plant_ids" id="edit_plant_ids" class="form-select" multiple>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Department</label>
              <select name="department_ids" id="edit_department_ids" class="form-select" multiple>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" id="edit_role" class="form-select">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </form>
        <div id="editUserStatus"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="editUserBtn">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">New Password</label>
          <input type="password" class="form-control" id="reset_password" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="resetBtn">Reset</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let resettingUserId = null;
let editingUserId = null;

document.getElementById('userSearch').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const userRows = document.querySelectorAll('#userTableBody tr');
    userRows.forEach(row => {
        const username = row.cells[1].textContent.toLowerCase();
        if (username.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

function openReset(id, username){
  resettingUserId = id;
  document.getElementById('reset_password').value = '';
  new bootstrap.Modal(document.getElementById('resetModal')).show();
}

function openEdit(id, username, role, plant_names_str, department_names_str){
  editingUserId = id;
  document.getElementById('edit_user_id').value = id;
  document.getElementById('edit_username').value = username;

  document.getElementById('edit_role').value = role;

  const plant_names = plant_names_str ? plant_names_str.split(',').map(p => p.trim()) : [];
  const department_names = department_names_str ? department_names_str.split(',').map(d => d.trim()) : [];

  Array.from(document.getElementById('edit_plant_ids').options).forEach(opt => {
    opt.selected = plant_names.includes(opt.text);
  });

  Array.from(document.getElementById('edit_department_ids').options).forEach(opt => {
    opt.selected = department_names.includes(opt.text);
  });

  new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

async function activateUser(id, username) {
  if (confirm(`Are you sure you want to activate user "${username}"?`)) {
    try {
      const res = await fetch(`/admin/users/${id}/activate`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}'} });
      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        DMS.showNotification(data.error || 'Failed to activate user', 'danger');
      }
    } catch (e) {
      DMS.showNotification('Network error', 'danger');
    }
  }
}

async function deactivateUser(id, username) {
  if (confirm(`Are you sure you want to deactivate user "${username}"?`)) {
    try {
      const res = await fetch(`/admin/users/${id}/deactivate`, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token() }}'} });
      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        DMS.showNotification(data.error || 'Failed to deactivate user', 'danger');
      }
    } catch (e) {
      DMS.showNotification('Network error', 'danger');
    }
  }
}

document.getElementById('createUserBtn').addEventListener('click', async function(){
  const btn = this;
  DMS.setLoadingState(btn, true);
  const form = document.getElementById('createUserForm');
  const formData = new FormData(form);
  const payload = {
    username: formData.get('username'),
    password: formData.get('password'),
    role: formData.get('role'),
    plant_ids: Array.from(document.getElementById('create_plant_ids').selectedOptions).map(opt => opt.value),
    department_ids: Array.from(document.getElementById('create_department_ids').selectedOptions).map(opt => opt.value)
  };
  try {
    const res = await fetch("{{ url_for('main.admin_users_create') }}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if(res.ok){ location.reload(); } else { DMS.showNotification(data.error || 'Failed to create user', 'danger'); }
  } catch(e){ DMS.showNotification('Network error', 'danger'); }
  finally { DMS.setLoadingState(btn, false); }
});

document.getElementById('resetBtn').addEventListener('click', async function(){
  const btn = this;
  DMS.setLoadingState(btn, true);
  const newPass = document.getElementById('reset_password').value;
  try {
    const res = await fetch(`{{ url_for('main.admin_users_reset_password', user_id=0) }}`.replace('/0/', `/${resettingUserId}/`), { method:'POST', headers: { 'Content-Type':'application/json', 'X-CSRFToken':'{{ csrf_token() }}' }, body: JSON.stringify({ password: newPass })});
    const data = await res.json();
    if(res.ok){ DMS.showNotification('Password reset successfully', 'success'); location.reload(); } else { DMS.showNotification(data.error || 'Failed to reset', 'danger'); }
  } catch(e){ DMS.showNotification('Network error', 'danger'); }
  finally { DMS.setLoadingState(btn, false); }
});

document.getElementById('editUserBtn').addEventListener('click', async function(){
  const btn = this;
  DMS.setLoadingState(btn, true);
  const form = document.getElementById('editUserForm');
  const formData = new FormData(form);
  const payload = {
    username: formData.get('username'),
    role: formData.get('role'),
    plant_ids: Array.from(document.getElementById('edit_plant_ids').selectedOptions).map(opt => opt.value),
    department_ids: Array.from(document.getElementById('edit_department_ids').selectedOptions).map(opt => opt.value)
  };
  try {
    const res = await fetch(`/admin/users/${editingUserId}/update`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'}, body: JSON.stringify(payload)});
    const data = await res.json();
    if(res.ok){ location.reload(); } else { DMS.showNotification(data.error || 'Failed to update user', 'danger'); }
  } catch(e){ DMS.showNotification('Network error', 'danger'); }
  finally { DMS.setLoadingState(btn, false); }
});

// Load plants/departments for create form
document.addEventListener('DOMContentLoaded', async function(){
  try {
    const [plantsRes, deptsRes] = await Promise.all([
      fetch("{{ url_for('main.api_plants') }}"),
      fetch("{{ url_for('main.api_departments') }}")
    ]);
    const plants = await plantsRes.json();
    const depts = await deptsRes.json();
    function fill(id, list){
      const el = document.getElementById(id);
      if(!el) return;
      el.innerHTML = list.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
    }
    fill('create_plant_ids', plants);
    fill('create_department_ids', depts);
    fill('edit_plant_ids', plants);
    fill('edit_department_ids', depts);
  } catch(e){ console.error(e); }
});
</script>
{% endblock %}


